{% extends "base.html" %}

{% block style %}
<style>
img {
    cursor: hand;
    cursor: pointer;
}

#draft_container {
    margin: auto;
    width: 1350px;
    display: none;
}

#pick_container {
    display: inline-block;
    margin: auto;
    background-image: url(http://hs.jwd.me/static/draft.png);
    background-repeat: no-repeat;
    background-size: 1092px 724px;
    width: 1092px;
    height: 724px;
    z-index: -1;
}

#list_container {
    display: inline-block;
    margin-left: 5px;
    margin-top: -11px;
    z-index: -1;
    width: 220px;
    position: absolute;
}

.arena_text {
    color: white;
    text-shadow:
          2px 2px 0 #222,
        -1px -1px 0 #000,  
         1px -1px 0 #000,
         -1px 1px 0 #000,
          1px 1px 0 #000;
    font-weight: normal;
    width: 300px;
    font-size: 1.2em;
}

.arena_text.drafting {
    display: block;
    margin: auto;
    padding-top: 17px;
}

.arena_text#choose {
    display: inline-block;
    vertical-align: top;
    position: relative;
    top: 97px;
    left: 205px;
    align: center;
}

.hero {
    display: inline-block;
    position: relative;
    vertical-align: top;
    width: 111px;
    margin: 20px 0 0 70px;
}

.hero .portrait {
    background-position: {{ x_offset }}px {{ y_offset }}px;
    background-image: url({{ hero_url }});
    background-repeat: no-repeat;
    height: 85px;
    width: 72px;
    position: relative;
    top: 21px;
    left: 20px;
    z-index: 2;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
}

.hero .portrait ~ .frame {
    background-image: url("http://hs.jwd.me/static/hero-frame.png");
    background-repeat: no-repeat;
    height: 127px;
    position: absolute;
    top: 0;
    left: 0;
    width: 111px;
    z-index: 3;
}

.pack_pick {
    width: 280px;
    margin-top: 30px;
}

.pack_pick:hover {
    padding: 3px 0 0 2px;
    margin: 0 -2px -3px 0;
    z-index: 10;
}

ul#draft_list {
    list-style-position: inside;
    list-style: none;
    font-size: 0.8em;
    padding: 0;
    width: 220px;
}

ul#draft_list li {
    background-color: #726358;
    color: #fff;
    font-weight: normal;
    border: 1px solid #222;
    border-radius: 3px;
    padding-top: 1px;
}

ul#draft_list li.warrior {background-color: #702116}
ul#draft_list li.shaman {background-color: #292f55}
ul#draft_list li.rogue {background-color: #3d3e42}
ul#draft_list li.paladin {background-color: #c07b23}
ul#draft_list li.hunter {background-color: #246521}
ul#draft_list li.druid {background-color: #6e411f}
ul#draft_list li.warlock {background-color: #503458}
ul#draft_list li.mage {background-color: #596896}
ul#draft_list li.priest {background-color: #b8bec1}

ul#draft_list li:before {
    content: '';
    display: inline-block;
    height: 24px;
    width: 24px;
    background-image: url(http://hs.jwd.me/static/gem.png);
    background-size:contain; 
    background-repeat:no-repeat;
    margin-top: 2px;
    vertical-align: middle;
}

span.card_cost {
    margin-left: -16px;
}

span.card_cost.offset {
    margin-left: -21px;
}

span.card_name {
    margin-left: 13px;
}

span.card_name.offset {
    margin-left: 11px;
}

span.card_name.neutral { color: #fff; }
span.card_name.rare { color: #418eff; }
span.card_name.epic { color: #d155f9; }
span.card_name.legendary { color: #ffb024; }

</style>
{% endblock %}
{% block script %}
<script>

$(document).ready(function () {
    var card_on_press = function(pick, pick_array){
        // immediately unbind the click event disabling more picks
 //       $(".pack_pick").click(function(){});
        $("ul#draft_list").empty();
        var content = '';
        var data = {};
        data['card-id']     = pick.attr('data-id');
        data['name']        = pick.attr('data-name');
        data['pick-number'] = pick.attr('data-pick-number');
        data['class']       = pick.attr('data-class').toLowerCase();
        data['rarity']      = pick.attr('data-rarity').toLowerCase();
        data['cost']        = pick.attr('data-cost');
        pick_array.push(data);
        pick_array.sort(function (a, b) {
            // sort callback
            if (parseInt(a['cost']) > parseInt(b['cost'])) {
                // if a is larger return 1
                return 1;
            } else if (parseInt(a['cost']) < parseInt(b['cost'])) {
                // if a is smaller return -1
                return -1;
            } else {
                // if a and b a are equal compare by their name
                // a earlier in th alphabet
                if (a['name'] < b['name']) return -1;
                // a later in the alphabet
                if (a['name'] > b['name']) return 1;                
                // same name and mana cost, equal
                return 0;
            }
        });
        $.each(pick_array, function(i, val) {
            var offset = '';
            if(val['cost'].toString().length > 1) {offset = 'offset'};
            content += '<li class="' + val['class'] + '">' + '<span class="card_cost ' + offset + '">' + val['cost'] + '</span><span class="card_name ' + val['rarity']+ ' ' + offset + '">' + val['name'] + '</span>';
            return_picks[i] = val;
        })
        $("ul#draft_list").append(content);        // if we are still making picks
        count +=1;
        if(count <= 30) {
            // update counter
            $("#count").html(count.toString());
            // hide/make sure all rows are hidden 
            $("tr.pack_row:nth-child(" + (count-1).toString() + ")").hide(0, function(){
                // show only the next row
                $("tr.pack_row:nth-child(" + count.toString() + ")").show(300, function(){
                    // once row is visible rebind card_on_press function
                    // $(".pack_pick").click = card_on_press
                })
            })
        } else {
            var end_time = $.now();
            var time_used = end_time - start_time;
            alert(time_used);
            var game_id = "{{ game_id }}";
            var hero_class = "{{ hero_class }}";
            $.post("/draftdone",{ draft_class: hero_class, game_id: game_id, picks:  JSON.stringify(return_picks), time_used: time_used }, function(response, status) {
                if(status == 'error') { alert(status) };
            }, "json").done(function(response) {
                alert(response);
            });
            // we are done making picks, game over
            $(".pack_row").hide(0, function(){
                $('#choose').html("GAME OVER")
            })
        }

    }
    var count = 1;
    var pick_array = [];
    var return_picks = {};
    var pick_numbers = [];
    var start_time = $.now();
    $("tr").hide(0);
    $("tr:first").show(100);
    $("#draft_container").show(500);
    $(".pack_pick").on("click", function() {
        if($.inArray($(this).attr('data-pick-number'), pick_numbers ) == -1) {
            pick_numbers.push($(this).attr('data-pick-number'))
            card_on_press($(this),pick_array);
        }
    });
})
</script>
{% endblock %}

{% block content %}
<div id="draft_container">
    <div id="pick_container">
        <h2 class="arena_text drafting">Now drafting: {{ hero_class }}</h2>
        <div class="hero">
            <div class="portrait"></div>
            <div class="frame"></div>
        </div>
        <h2 class="arena_text" id="choose">Choose a card ( <span id="count">1</span> / 30 )</h2>
        <table id="pack_table">
        {% for pack in draft %}
            <tr class="pack_row">
                <td><img 
                    class="pack_pick" 
                    data-pick-number={{ loop.index }} 
                    data-id="{{ pack[0][0] }}" 
                    data-name="{{ pack[0][1] }}" 
                    data-cost="{{ pack[0][2] }}" 
                    data-class="{{ pack[0][3] }}" 
                    data-rarity="{{ pack[0][4] }}" 
                    src="http://hs.jwd.me/static/cards/{{ pack[0][0] }}.png">
                <td><img 
                    class="pack_pick" 
                    data-pick-number={{ loop.index }} 
                    data-id="{{ pack[1][0] }}" 
                    data-name="{{ pack[1][1] }}" 
                    data-cost="{{ pack[1][2] }}" 
                    data-class="{{ pack[1][3] }}" 
                    data-rarity="{{ pack[1][4] }}" 
                    src="http://hs.jwd.me/static/cards/{{ pack[1][0] }}.png">
                <td><img 
                    class="pack_pick" 
                    data-pick-number={{ loop.index }} 
                    data-id="{{ pack[2][0] }}" 
                    data-name="{{ pack[2][1] }}" 
                    data-cost="{{ pack[2][2] }}" 
                    data-class="{{ pack[2][3] }}" 
                    data-rarity="{{ pack[2][4] }}" 
                    src="http://hs.jwd.me/static/cards/{{ pack[2][0] }}.png">
            </tr>
        {% endfor %}
        </table>
    </div>
    <div id="list_container">
        <ul class="arena_text" id="draft_list"></ul>
    </div>
 </div>
{% endblock %}
